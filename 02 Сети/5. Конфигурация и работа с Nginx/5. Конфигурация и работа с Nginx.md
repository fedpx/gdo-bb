# Задание
## Настройка обратного прокси
1. Установите Python и Flask. Создайте простое Flask-приложение, которое будет запускаться на порту 5000. Оно должно возвращать текст, например, "Hello from Flask!".
2. Настройте Nginx для проксирования запросов:
	- Настройте так, чтобы запросы к http://mysite.local/api/ перенаправлялись на ваше Flask-приложение. 
3. Перезапустите Flask-приложение и Nginx. Проверьте, что запросы к http://mysite.local/api/ возвращают ответ от вашего Flask-приложения.

**Конечный результат**: При переходе по адресу http://mysite.local/api/ в браузере вы должны видеть сообщение из вашего Flask-приложения. Убедитесь, что ответ от приложения появляется, и проверьте логи Nginx для подтверждения, что запросы проксируются.
### ### 1. Установка Python и Flask
```
# Установка Python и pip (если еще не установлены)
sudo apt update
sudo apt install python3 python3-pip python3.12-venv python3-flask
```
1. **Создайте виртуальное окружение:**
```
python3 -m venv ~/myflaskenv
```    
2. **Активируйте виртуальное окружение:**
```  
source ~/myflaskenv/bin/activate
```
Теперь в начале строки терминала должно появиться `(myflaskenv)`.
3. **Установите Flask в виртуальном окружении:**
```
pip install flask
``` 
4. **Создайте Flask-приложение:**
```
nano ~/app.py
``` 
Содержимое файла:
```   
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
	return "Hello from Flask!"
    
if __name__ == '__main__':
	app.run(host='0.0.0.0', port=5000)
```    
5. **Запустите приложение (в виртуальном окружении):**
```
python ~/app.py
```
### 2. Установка и настройка Nginx
Установка Nginx:
```
sudo apt install nginx
```
Создайте конфигурационный файл для вашего сайта:
```
sudo nano /etc/nginx/sites-available/mysite.local
```
Добавьте следующее содержимое:
```
server {
    listen 80;
    server_name mysite.local;

    location /api/ {
        proxy_pass http://127.0.0.1:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```
Активируйте конфигурацию:
```
sudo ln -s /etc/nginx/sites-available/mysite.local /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```
### 3. Настройка hosts файла
Добавьте в файл `/etc/hosts` строку:
```
127.0.0.1 mysite.local
```
### 4. Проверка работы
1. Перезапустите Flask-приложение:
```
python3 app.py
```
2. В другом терминале проверьте:
```
curl http://mysite.local/api/
```
Должно вернуться "Hello from Flask!"
3. Проверьте логи Nginx:
```
sudo tail -f /var/log/nginx/access.log
```

![CleanShot 2025-07-23 at 20.06.39@2x.png](CleanShot%202025-07-23%20at%2020.06.39@2x.png)
## Балансировка нагрузки
1. Создайте два Flask-приложения на портах 5001 и 5002. Каждое должно возвращать уникальный текст, например, "Hello from App 1!" и "Hello from App 2!".
2. Настройте Nginx для балансировки нагрузки:
	- Настройте upstream-блок, который включает оба Flask-приложения.
	- Настройте проксирование всех запросов к http://mysite.local/ на этот upstream-блок.
3. Перезапустите приложения и Nginx. Проверьте, что запросы распределяются между двумя приложениями.

**Конечный результат**: При обновлении страницы на http://mysite.local в браузере вы должны видеть чередующиеся ответы от двух Flask-приложений. Обновите страницу несколько раз и убедитесь, что ответы от приложений чередуются. Проверьте логи Nginx для подтверждения распределения запросов.
### 1. Создаем два Flask-приложения
**Приложение 1 (порт 5001):**
```
vim ~/app1.py
```
Содержимое:
```
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return "Hello from App 1!"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001)
```
**Приложение 2 (порт 5002):**
```
vim ~/app2.py
```
Содержимое:
```
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return "Hello from App 2!"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5002)
```
### 2. Запускаем приложения
В двух разных терминалах (предварительно активировав виртуальное окружение):
```
python3 ~/app1.py
```
и
```
python3 ~/app2.py
```
### 3. Настраиваем Nginx для балансировки нагрузки
Редактируем конфигурацию Nginx:
```
sudo vim /etc/nginx/sites-available/mysite.local
```
Замените содержимое на:
```
upstream flask_apps {
    server 127.0.0.1:5001;
    server 127.0.0.1:5002;
}

server {
    listen 80;
    server_name mysite.local;

    location / {
        proxy_pass http://flask_apps;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```
### 4. Применяем изменения
```
sudo nginx -t && sudo systemctl restart nginx
```
### 5. Проверяем работу
1. Откройте в браузере [http://mysite.local](http://mysite.local/)
2. Обновите страницу несколько раз - вы должны видеть чередующиеся сообщения:
    - "Hello from App 1!"
    - "Hello from App 2!"
3. Проверьте логи Nginx:
```
sudo tail -f /var/log/nginx/access.log
```
В логах будут видны обращения к разным портам (5001 и 5002).

![CleanShot 2025-07-23 at 20.11.36@2x.png](CleanShot%202025-07-23%20at%2020.11.36@2x.png)




# Задание
## 1. Установка MongoDB и настройка окружения 
- Установите MongoDB на свой компьютер или сервер 
- Настройте базу данных, создайте основную коллекцию users, в которой будут храниться профили пользователей. Каждая запись должна содержать поля: user_id, name, age, friends (список идентификаторов друзей).
- Изучите интерфейс командной строки MongoDB или MongoDB Atlas для выполнения запросов.
## 2. Создание и добавление данных
Создайте несколько документов в коллекции users, используя такие поля:
- user_id: уникальный идентификатор пользователя.
- name: имя пользователя.
- age: возраст пользователя.
- friends: массив идентификаторов друзей.
Добавьте пять различных записей, при этом каждая запись должна иметь разное количество друзей. Используйте команду insertOne() для добавления одного документа и insertMany() для добавления нескольких записей за один запрос.
## 3. Извлечение данных и фильтрация 
Используйте команды find () и findOne() для извлечения информации о пользователях:
- Извлеките всех пользователей с возрастом больше 20 лет.
- Найдите пользователя по имени и отобразите его друзей.
- Извлеките пользователей, у которых в списке друзей определенное количество друзей.
- Попробуйте отсортировать результаты по возрасту в порядке убывания.
## 4. Использование вложенных данных и массивов 
- Добавьте к документам пользователей дополнительное поле posts, представляющее собой массив объектов. Каждый объект в массиве posts должен включать: post_id, content, date.
- Используйте MongoDB запрос для извлечения пользователей с определенной фразой в посте. 
- Убедитесь, что запросы извлекают только нужные данные, используя проекцию (.find (0), {поле: 1))).
## 5. Изучение индексов для оптимизации поиска 
- Создайте индекс для поля name в коллекции users для ускорения поиска пользователей по имени. 
- Сравните время выполнения поиска по полю name до и после создания индекса. Сначала выполните поиск без индекса, зафиксируйте время выполнения, затем создайте индекс и повторите запрос, сравнив время.
## 6. Обновление и удаление данных 
- Обновите возраст одного из пользователей, увеличив его на 5 лет, используя команду updateOne (). 
- Удалите всех пользователей младше 18 лет с помощью команды deleteMany().
- После удаления выполните запрос для подтверждения удаления.
## 7. Бэкап и восстановление данных 
- Создайте резервную копию коллекции users с помощью команды mongodump.
- Удалите один из документов в коллекции, а затем восстановите коллекцию из резервной копии с помощью mongorestore


# Шаг 1. Поднять MongoDB в Docker
## 1) Запускаем контейнер с персистентным томом и авторизацией
```
# Создадим тома для данных и бэкапов 
docker volume create mongo_data 
docker volume create mongo_backup  
# Запускаем MongoDB 7.x 
docker run -d --name mongo \   
-p 27017:27017 \   
-v mongo_data:/data/db \   
-v mongo_backup:/backup \   
-e MONGO_INITDB_ROOT_USERNAME=root \   
-e MONGO_INITDB_ROOT_PASSWORD=secret \   
mongo:7
```
Проверка, что контейнер жив:
```
docker ps --filter name=mongo
```
## 2) Подключаемся к mongosh (через образ)
```
docker run --rm -it --network host mongo:7 mongosh "mongodb://root:secret@localhost:27017/?authSource=admin"
```
> Если `--network host` недоступен, можно так:  
> `docker run --rm -it --network container:mongo mongo:7 mongosh "mongodb://root:secret@localhost:27017/?authSource=admin"`

Внутри `mongosh` создаём БД/коллекцию:
```
use social db.createCollection("users") db.getName() db.getCollectionNames()
```

**Что прислать на проверку (коротко):**
- вывод `docker ps --filter name=mongo`
- из `mongosh`: `db.getName()` и `db.getCollectionNames()`

Если ок — идём дальше.

---
# Шаг 2. Добавление данных (insertOne / insertMany)

Подключись в `mongosh` так же, как выше, и выполни:
```
use social  

// insertOne 
db.users.insertOne({   
	user_id: 1001,   
	name: "Alice",   
	age: 22,   
	friends: [1002, 1003] 
})  

// insertMany 
db.users.insertMany([   
	{ user_id: 1002, name: "Bob",     age: 19, friends: [1001] },   
	{ user_id: 1003, name: "Charlie", age: 28, friends: [1001, 1004, 1005] },   
	{ user_id: 1004, name: "Diana",   age: 34, friends: [] },   
	{ user_id: 1005, name: "Eve",     age: 25, friends: [1003, 1001] } ])  
	
// Быстрая проверка 
db.users.find({}, {_id:0}).sort({user_id:1})
```
**Что прислать:** вывод последней команды (5 документов).

---
# Шаг 3. Извлечение и фильтрация
```
// > 20 лет 
db.users.find({ age: { $gt: 20 } }, { _id:0, user_id:1, name:1, age:1 })  

// Найти по имени и показать друзей 
db.users.findOne({ name: "Charlie" }, { _id:0, friends:1 })  

// Ровно 2 друга 
db.users.find({ friends: { $size: 2 } }, { _id:0, user_id:1, name:1, friends:1 })  

// Сортировка по возрасту по убыванию 
db.users.find({}, { _id:0, user_id:1, name:1, age:1 }).sort({ age: -1 })
```

**Что прислать:** короткие результаты (по 1–3 строки на каждый запрос).

---
# Шаг 4. Вложенные данные (posts) и проекция
```
// Добавим поле posts 
db.users.updateOne(   
	{ user_id: 1001 },   
	{ $set: {
		posts: [         
			{ post_id: 1, content: "Hello world from Alice", date: ISODate("2025-08-01T09:00:00Z") },         
			{ post_id: 2, content: "MongoDB is awesome",     date: ISODate("2025-08-05T12:30:00Z") }
	    ]   
	}} 
)  

db.users.updateOne(   
	{ user_id: 1002 },   
	{ $set: { posts: [ { post_id: 3, content: "Learning databases", date: ISODate("2025-08-02T10:00:00Z") } ] } } 
)  

db.users.updateOne(
	{ user_id: 1003 },   
	{ $set: { posts: [ { post_id: 4, content: "DevOps and MongoDB", date: ISODate("2025-08-06T08:00:00Z") } ] } } 
)  

db.users.updateOne({ user_id: 1004 }, { $set: { posts: [] } })  

db.users.updateOne(   
	{ user_id: 1005 },   
	{ $set: { posts: [ { post_id: 5, content: "Search phrase inside post", date: ISODate("2025-08-07T16:45:00Z") } ] } } 
)  

// Поиск пользователей, где в постах встречается "mongodb" (без учета регистра) // и вернуть только совпавший элемент массива (проекция $elemMatch) 
db.users.find(   
	{ "posts.content": /mongodb/i },   
	{ _id:0, user_id:1, name:1, posts: { $elemMatch: { content: /mongodb/i } } } )
```

**Что прислать:** вывод последнего запроса (должны прийти пользователи с постами, где есть “MongoDB”, и только совпавшие посты).

---
# Шаг 5. Индекс по `name` и сравнение плана
```
// До индекса 
db.users.find({ name: "Alice" }).explain("executionStats")  

// Создаём индекс 
db.users.createIndex({ name: 1 })  

// После индекса 
db.users.find({ name: "Alice" }).explain("executionStats")
```

**Что прислать:** из обоих explain два поля — `executionTimeMillis` и `totalDocsExamined`.

---
# Шаг 6. Обновление и удаление
```
// +5 лет пользователю 1005 
db.users.updateOne({ user_id: 1005 }, { $inc: { age: 5 } }) 
db.users.find({ user_id: 1005 }, { _id:0, user_id:1, name:1, age:1 })  

// Удалить всех младше 18 
db.users.deleteMany({ age: { $lt: 18 } })  

// Подтверждение 
db.users.countDocuments({ age: { $lt: 18 } })
```

**Что прислать:** обновлённый документ 1005 и число из последней команды.

---
# Шаг 7. Бэкап и восстановление (всё через Docker)

## 7.1. Дамп коллекции `users` в смонтированную папку `/backup`
```
# Снимем дамп средствами образа (в /backup внутри контейнера есть том) docker exec mongo sh -lc 'mongodump --username root --password secret --authenticationDatabase admin --db social --collection users --out /backup/dump_$(date +%F)'
```

Проверим, что файлы есть:
```
docker exec mongo sh -lc 'ls -R /backup'
```
## 7.2. Смоделируем потерю и восстановим
```
# Удалим один документ 
docker run --rm -i --network host mongo:7 mongosh "mongodb://root:secret@localhost:27017/?authSource=admin" --eval 'use social; db.users.deleteOne({user_id:1001}); db.users.find({user_id:1001}).count()'  

# Восстановление (перезапишет коллекцию) 
docker exec mongo sh -lc 'mongorestore --username root --password secret --authenticationDatabase admin --drop --db social /backup/dump_$(date +%F)/social'
```

Проверка, что документ вернулся:
```
docker run --rm -i --network host mongo:7 mongosh "mongodb://root:secret@localhost:27017/?authSource=admin" --eval 'use social; db.users.find({user_id:1001},{_id:0}).toArray()'
```
**Что прислать:**  
— вывод `ls -R /backup`,  
— число после удаления (должно быть `0`),  
— и результат финальной проверки (документ 1001 снова на месте).